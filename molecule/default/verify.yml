---
- hosts: all
  tasks:
    - name: Run default rsnapshot
      shell: >
        /bin/date >
        /root/rsnapshot//timestamp.hourly;
        /usr/bin/rsnapshot
        -c /etc/rsnapshot.conf
        hourly

    - name: Check for backup
      stat:
        path: /opt/backup/rsnapshot/hourly.0/backup-defaul/root/rsnapshot/timestamp.hourly

    - name: .my.cnf exists    
      command: cat /root/.my.cnf

    - name: Create test table in database and insert test value
      community.mysql.mysql_query:
        query:
          - CREATE TABLE IF NOT EXISTS test (message varchar(255) NOT NULL) ENGINE=MyISAM DEFAULT CHARSET=utf8;
          - INSERT INTO test(message) VALUES('Ansible value');
        login_db: testDatabase

    - name: Create backup script
      template:
        src: backup.sh.j2
        dest: /root
        owner: root
        group: root
        mode: "0600"

    - name: Create backup with backup script
      shell: backup.sh
      args:
        chdir: /root/
        executable: /bin/bash

    - name: Drop test database
      community.mysql.mysql_query:
        query: DROP DATABASE testDatabase;
        login_db: testDatabase

    - name: Create a new database testDatabase
      community.mysql.mysql_db:
        name: testDatabase
        state: present

    - name: Restore database
      community.mysql.mysql_db:
        name: testDatabase
        state: import
        target: /opt/mysqlbackup/mysqldump_$(date +%Y%m%d).sql.bz2

    - name: Simple select query to acme db
      community.mysql.mysql_query:
        login_db: testDatabase
        query: SELECT message FROM test
